#+TITLE: My Emacs configuration
#+AUTHOR: Sergey Korolev
#+EMAIL: korolev.srg@gmail.com
#+PROPERTY: header-args:elisp :tangle "init.el" :comments org
#+OPTIONS: ^:{}

* About                                                            :noexport:
This is my Emacs configuration, built with =use-package= and
=org-mode=. =use-package= allows declarative description of packages and it’s
settings, =org-mode= allows to represent this configuration as document and
generate config from it.

This file declares local variable hook - run =org-babel-tangle= on every save.

** Usage                                                          :noexport:
Clone repository to =~/.emacs.d= and run Emacs.

** Table of Contents                                           :TOC@3:QUOTE:
#+BEGIN_QUOTE
- [[#initialization][Initialization]]
  - [[#header][Header]]
  - [[#early-init---performance-hacks][Early Init - performance hacks]]
  - [[#garbage-collector-hack][Garbage collector hack]]
  - [[#initialize-use-package][Initialize 'use-package]]
  - [[#benchmarking][Benchmarking]]
  - [[#setup-standard-file-paths][Setup standard file paths]]
- [[#dependencies][Dependencies]]
  - [[#icons][Icons]]
- [[#keybindings][Keybindings]]
  - [[#cheat-sheet][Cheat sheet]]
  - [[#evil-mode][Evil mode]]
  - [[#evil-collection][Evil collection]]
  - [[#el-general][El General]]
  - [[#reverse-im][Reverse-im]]
  - [[#some-global-keybindings][Some global keybindings]]
- [[#essential-settings][Essential settings]]
  - [[#emacs-variables-that-defined-in-c-source-code][Emacs variables that defined in C source code]]
  - [[#files][Files]]
  - [[#save-place][Save place]]
  - [[#advice][Advice]]
  - [[#apropos][Apropos]]
  - [[#recent-files][Recent files]]
  - [[#save-history][Save history]]
  - [[#auto-revert][Auto revert]]
  - [[#desktop-save-and-load][Desktop save and load]]
  - [[#persistent-scratch-buffer][Persistent Scratch buffer]]
  - [[#customization][Customization]]
- [[#gui][GUI]]
  - [[#mouse][Mouse]]
  - [[#tooltips][Tooltips]]
  - [[#frame][Frame]]
  - [[#winner-mode][Winner mode]]
  - [[#doom-theme][Doom theme]]
  - [[#modeline][Modeline]]
  - [[#solaire-mode][Solaire mode]]
  - [[#evil-goggles][Evil goggles]]
- [[#autocomplete][Autocomplete]]
  - [[#prescient][Prescient]]
  - [[#ivy--counsel--swiper-stack][Ivy / Counsel / Swiper stack]]
    - [[#ivy][Ivy]]
    - [[#ivy-prescient][Ivy prescient]]
    - [[#counsel][Counsel]]
    - [[#swiper][Swiper]]
    - [[#ivy-rich][Ivy rich]]
  - [[#company][Company]]
    - [[#core][Core]]
    - [[#company-prescient][Company Prescient]]
    - [[#company-box][Company Box]]
- [[#help--manual][Help & manual]]
  - [[#which-key][Which key]]
  - [[#better-help][Better help]]
- [[#navigation][Navigation]]
  - [[#avy][Avy]]
- [[#buffer-management][Buffer management]]
  - [[#unique-buffer-names][Unique buffer names]]
  - [[#ibuffer][ibuffer]]
- [[#project-management][Project management]]
  - [[#projectile][Projectile]]
  - [[#projectile-ivy-integration][Projectile Ivy integration]]
- [[#file-management][File management]]
- [[#editing][Editing]]
  - [[#simple][Simple]]
  - [[#delete-selection][Delete selection]]
  - [[#whitespaces][Whitespaces]]
  - [[#move-visual-block][Move visual block]]
  - [[#on-the-fly-spell-checker][On-the-fly spell checker]]
  - [[#undo-tree][Undo Tree]]
- [[#productivity--task-management][Productivity & task management]]
  - [[#org-mode][Org mode]]
    - [[#core-1][Core]]
    - [[#evil][Evil]]
    - [[#org-bullets][Org Bullets]]
    - [[#fancy-priorities][Fancy Priorities]]
    - [[#table-of-contents][Table of Contents]]
- [[#version-control][Version Control]]
  - [[#diff-hl][diff-hl]]
  - [[#ediff][Ediff]]
  - [[#magit][Magit]]
  - [[#magit-todo][Magit TODO]]
  - [[#git-time-machine][Git Time Machine]]
  - [[#browse-at-remote][Browse at remote]]
  - [[#git-related-modes][Git related modes]]
- [[#coding][Coding]]
  - [[#eldoc][Eldoc]]
  - [[#tabify][Tabify]]
  - [[#highlight-matching-parens][Highlight matching parens]]
  - [[#automatic-parenthesis-pairing][Automatic parenthesis pairing]]
  - [[#display-line-numbers][Display line numbers]]
  - [[#highlight-todos][Highlight TODOs]]
  - [[#evil-commentary][Evil commentary]]
  - [[#evil-surround][Evil surround]]
  - [[#aggressive-indent][Aggressive Indent]]
  - [[#flycheck][Flycheck]]
  - [[#snippets][Snippets]]
  - [[#direnv][direnv]]
  - [[#lsp][LSP]]
  - [[#programming-modes][Programming Modes]]
    - [[#emacs-lisp][Emacs Lisp]]
    - [[#cc][C/C++]]
    - [[#nix][Nix]]
    - [[#python][Python]]
    - [[#javascript][Javascript]]
- [[#the-end][The end…]]
#+END_QUOTE

* Initialization
Initial bootstrapping and things related to package management.

** Header
#+begin_src elisp :comments no
  ;;; init.el -- My Emacs Configuration.
  ;;; Commentary:
  ;;; This file was tangled (automatically generated) from `README.org'
  ;;; Code:

  ;; -*- lexical-binding: t -*-

  ;; Load 'early-init on old versions
  (unless (>= emacs-major-version 27)
    (load-file
     (expand-file-name "early-init.el"
                       (file-name-directory (or load-file-name buffer-file-name)))))
#+end_src

** Early Init - performance hacks
Emacs HEAD (27+) introduces =early-init.el=, which is run before =init.el=,
before package and UI initialization happens. So, some performance hack lives here.

#+begin_src elisp :tangle "early-init.el" :comments no
  ;;; early-init.el -- My Emacs Configuration.
  ;;; Commentary:
  ;;; This file was tangled (automatically generated) from `README.org'
  ;;; Code:
  ;; -*- lexical-binding: t -*-

  ;; Defer garbage collection further back in the startup process.
  ;; Reset it later by enabling `gcmh-mode'.
  (setq gc-cons-threshold most-positive-fixnum)

  ;; In Emacs 27+, package initialization occurs before `user-init-file' is
  ;; loaded, but after `early-init-file'. We want init packages manually.
  (setq package-enable-at-startup nil)

  ;; In noninteractive sessions, prioritize non-byte-compiled source files to prevent
  ;; the use of stale byte-code. Otherwise, it saves us a little IO time to skip the
  ;; =mtime= checks on every *.elc file we load.
  (setq load-prefer-newer noninteractive)

  ;; Don't make a second case-insensitive pass over =auto-mode-alist=. If it has to,
  ;; it's our (the user's) failure. One case for all!
  (setq auto-mode-case-fold nil)

  ;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
  (push '(menu-bar-lines . 0) default-frame-alist)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (push '(vertical-scroll-bars) default-frame-alist)

  ;; Resizing the Emacs frame can be a terribly expensive part of changing the
  ;; font. By inhibiting this, we easily halve startup times with fonts that are
  ;; larger than the system default.
  (setq frame-inhibit-implied-resize t)

  ;; Ignore X resources; its settings would be redundant with the other settings
  ;; in this file and can conflict with later config (particularly where the
  ;; cursor color is concerned).
  (advice-add #'x-apply-session-resources :override #'ignore)

  ;; Remove command line options that aren't relevant to our current OS;
  ;; that means less to process at startup.
  (unless (eq system-type 'darwin) (setq command-line-ns-option-alist nil))
  (unless (eq system-type 'gnu/linux) (setq command-line-x-option-alist nil))

  ;; Don’t compact font caches during garbage collect.
  (setq inhibit-compacting-font-caches t)

  ;; Disable bidirectional text rendering for a modest performance boost. No RTL, oops.
  (setq-default bidi-display-reordering 'left-to-right)

  ;; Reduce rendering/line scan work for Emacs by not rendering cursors or regions in
  ;; non-focused windows.
  (setq-default cursor-in-non-selected-windows nil)


  (provide 'early-init)
  ;;; early-init.el ends here
#+end_src

** Garbage collector hack
Set garbage collection threshold to the normal value on setup complete. Run GC
on idle. Don't run GC in minibuffer and run on exit.

#+begin_src elisp
  (defvar knopki/gc-cons-threshold (* 30 1024 1024)
    "The default value to use for `gc-cons-threshold'.
  If you experience freezing, decrease this.
  If you experience stuttering, increase this.")

  (add-hook 'emacs-startup-hook
            (lambda ()
              ;; Return GC cons to normal value after loading
              (setq gc-cons-threshold knopki/gc-cons-threshold)

              ;; Run GC after some idle
              (run-with-idle-timer 5 t #'garbage-collect)

              ;; Don't GC in minibuffer at all
              (add-hook 'minibuffer-setup-hook
                        (lambda () (setq gc-cons-threshold most-positive-fixnum)))

              ;; GC after minibuffer exit
              (add-hook 'minibuffer-exit-hook
                        (lambda () (setq gc-cons-threshold knopki/gc-cons-threshold)))))
#+end_src

** Initialize 'use-package
=use-package= package is the central gear of my configuration.

HACK: DO NOT copy package-selected-packages to init/custom file forcibly - [[https://github.com/jwiegley/use-package/issues/383#issuecomment-247801751][ref]]

#+begin_src elisp
  (defun my-save-selected-packages (&optional value)
    "Set `package-selected-packages' to VALUE but don't save to `custom-file'."
    (when value
      (setq package-selected-packages value)))
  (advice-add 'package--save-selected-packages :override #'my-save-selected-packages)
#+end_src

Setup package archives.

#+begin_src elisp
  (require 'package)
  (customize-set-variable 'package-archives
        (append (eval (car (get 'package-archives 'standard-value)))
                '(("org" . "http://orgmode.org/elpa/")
                  ("gnu"          . "https://elpa.gnu.org/packages/")
                  ("melpa" . "http://melpa.org/packages/"))))
#+end_src

Initialize packages.

#+begin_src elisp
  (unless (bound-and-true-p package--initialized) ; To avoid warnings in 27
    (setq package-enable-at-startup nil)          ; To prevent initializing twice
    (package-initialize))
#+end_src

Setup =use-package=.

#+begin_src elisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  ;; Should set before loading `use-package'
  (eval-and-compile
    (setq use-package-always-ensure t))

  (eval-when-compile
    (require 'use-package))

  ;; Required by `use-package'
  (use-package diminish)
  (use-package bind-key)
#+end_src

Update GPG keyring for GNU ELPA.

#+begin_src elisp
  (use-package gnu-elpa-keyring-update)
#+end_src

** Benchmarking
Enable startup benchmarking if started with =EMACS_BENCHMARK= environment
variable is set.

#+begin_src elisp
  (when (getenv "EMACS_BENCHMARK")
    (use-package benchmark-init
      :defines swiper-font-lock-exclude
      :commands (benchmark-init/activate)
      :hook (after-init . benchmark-init/deactivate)
      :init (benchmark-init/activate)
      :config
      (setq use-package-compute-statistics t)
      (with-eval-after-load 'swiper
        (add-to-list 'swiper-font-lock-exclude 'benchmark-init/tree-mode))))
#+end_src
** Setup standard file paths
The default paths used to store configuration files and persistent data are not
consistent across Emacs packages. This package sets out to fix this by changing
the values of path variables to put configuration files in
no-littering-etc-directory (defaulting to =~/.emacs.d/etc/=) and persistent data
files in no-littering-var-directory (defaulting to =~/.emacs.d/var/=), and by
using descriptive file names and subdirectories when appropriate.

#+begin_src elisp
  (use-package no-littering :demand)
#+end_src
* Dependencies
** Icons
Dependency of many packages. Display nice icons.

#+begin_src elisp
  (use-package all-the-icons
    :if (display-graphic-p)
    :init (unless (or (eq system-type 'windows-nt)
                      (member "all-the-icons" (font-family-list)))
            (all-the-icons-install-fonts t))
    :config
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(xwidget-webkit-mode all-the-icons-faicon "chrome" :v-adjust -0.1 :face all-the-icons-blue))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(diff-mode all-the-icons-octicon "git-compare" :v-adjust 0.0 :face all-the-icons-lred))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(flycheck-error-list-mode all-the-icons-octicon "checklist" :height 1.1 :v-adjust 0.0 :face all-the-icons-lred))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(elfeed-search-mode all-the-icons-faicon "rss-square" :v-adjust -0.1 :face all-the-icons-orange))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(elfeed-show-mode all-the-icons-octicon "rss" :height 1.1 :v-adjust 0.0 :face all-the-icons-lorange))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.[bB][iI][nN]$" all-the-icons-octicon "file-binary" :v-adjust 0.0 :face all-the-icons-yellow))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.c?make$" all-the-icons-fileicon "gnu" :face all-the-icons-dorange))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.conf$" all-the-icons-octicon "settings" :v-adjust 0.0 :face all-the-icons-yellow))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.toml$" all-the-icons-octicon "settings" :v-adjust 0.0 :face all-the-icons-yellow))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(conf-mode all-the-icons-octicon "settings" :v-adjust 0.0 :face all-the-icons-yellow))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(conf-space-mode all-the-icons-octicon "settings" :v-adjust 0.0 :face all-the-icons-yellow))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(forge-topic-mode all-the-icons-alltheicon "git" :face all-the-icons-blue))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.xpm$" all-the-icons-octicon "file-media" :v-adjust 0.0 :face all-the-icons-dgreen))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(helpful-mode all-the-icons-faicon "info-circle" :height 1.1 :v-adjust -0.1 :face all-the-icons-purple))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(Info-mode all-the-icons-faicon "info-circle" :height 1.1 :v-adjust -0.1))
    (add-to-list 'all-the-icons-icon-alist
                 '(".*\\.ipynb\\'" all-the-icons-fileicon "jupyter" :height 1.2 :face all-the-icons-orange))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(ein:notebooklist-mode all-the-icons-faicon "book" :face all-the-icons-lorange))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(ein:notebook-mode all-the-icons-fileicon "jupyter" :height 1.2 :face all-the-icons-orange))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(ein:notebook-multilang-mode all-the-icons-fileicon "jupyter" :height 1.2 :face all-the-icons-dorange))
    (add-to-list 'all-the-icons-icon-alist
                 '("\\.epub\\'" all-the-icons-faicon "book" :height 1.0 :v-adjust -0.1 :face all-the-icons-green))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(nov-mode all-the-icons-faicon "book" :height 1.0 :v-adjust -0.1 :face all-the-icons-green))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(gfm-mode all-the-icons-octicon "markdown" :face all-the-icons-lblue)))
#+end_src
* Keybindings
** Cheat sheet
Some non-standard key bindings.

|-----------+---------------+------------------------------|
| Hotkey    | Mode          | Meaning                      |
|-----------+---------------+------------------------------|
| SPC <f1>  |               | general-describe-keybindings |
| SPC <f2>  |               | which-key-show-top-level     |
| SPC <f3>  |               | which-key-show-major-mode    |
| SPC <f4>  |               | which-key-show-full-keymap   |
| SPC <f5>  |               | undo-tree-visualize          |
|           |               |                              |
| C-'       | normal visual | avy go to char               |
| C-"       | normal visual | avy go to word               |
|           |               |                              |
| J/K       | visual        | move visual block            |
|           |               |                              |
| SPC c     |               | run calculator               |
|           |               |                              |
| gc ...    | normal visual | evil commentary prefix       |
|           |               |                              |
| s         | operator      | evil-surround-edit           |
| S         | operator      | evil-Surround-edit           |
| S         | visual        | evil-surround-region         |
| gS        | visual        | evil-Surround-region         |
|           |               |                              |
| SPC o a   |               | org agenda                   |
| SPC o c   |               | org capture                  |
| SPC o l   |               | org agenda list              |
| SPC o s   |               | org search                   |
|           |               |                              |
| SPC p ... |               | projectile menu              |
|           |               |                              |
| SPC g ... |               | magit status                 |
|           |               |                              |
| SPC y ... |               | yasnippet insert snipped     |
|           |               |                              |
|-----------+---------------+------------------------------|
** Evil mode
I like VIM keys much more, so =evil-mode= is essential part of my configuration.

#+begin_src elisp
  (use-package evil
    :diminish undo-tree-mode
    :hook (after-init . evil-mode)
    :custom
    (evil-want-keybinding nil "Don't load evil-keybindings - required by evil-collection")
    (evil-motion-state-modes nil "Use 'normal instead of 'motion state.")
    (evil-emacs-state-modes nil "Use 'normal instead of 'emacs state.")
    (evil-search-wrap t "Search wrap around the buffer.")
    (evil-regexp-search t "Search with regexp.")
    (evil-search-module 'evil-search "Search module to use.")
    (evil-vsplit-window-right t "Like vim's 'splitright'.")
    (evil-split-window-below t "Like vim's 'splitbelow'.")
    (evil-want-C-u-scroll t "Enable C-u scroll.")
    (evil-want-C-i-jump nil "Disable C-i jumps in jump list.")
    :config
    ;; Visually selected text gets replaced by the latest copy action
    ;; Amazing hack lifted from: http://emacs.stackexchange.com/a/15054/12585
    (fset 'evil-visual-update-x-selection 'ignore)

    ;; Kill buffer without window
    (evil-ex-define-cmd "bd[elete]" #'kill-this-buffer))
#+end_src
** Evil collection
Vim-like keybindings everywhere in Emacs.

#+begin_src elisp
  (use-package evil-collection
    :after evil
    :custom
    (evil-collection-setup-minibuffer t)
    :config
    (evil-collection-init))
#+end_src
** El General
More convenient method for binding keys. Setup leader key definers.

#+begin_src elisp
  (use-package general
    :config
    (general-evil-setup)

    (general-create-definer general-leader
      :keymaps 'override
      :states '(insert motion normal emacs)
      :prefix "SPC"
      :non-normal-prefix "M-SPC")
    (general-create-definer general-major-leader
      :states '(insert motion emacs)
      :prefix ","
      :non-normal-prefix "M-,")
    (general-nmap "SPC m" (general-simulate-key "," :which-key "major mode")))
#+end_src
** Reverse-im
Use bindings while the non-default system layout is active.

#+begin_src elisp
  (use-package reverse-im
    :custom
    (reverse-im-modifiers '(control meta super))
    :config
    (reverse-im-activate "russian-computer"))
#+end_src
** Some global keybindings
#+begin_src elisp
  (general-leader
    ""     nil
    "<f1>" 'general-describe-keybindings
    "ac"  'calc-dispatch
    "ap"  'list-processes
    "aP"  'proced)
#+end_src
* Essential settings
** Emacs variables that defined in C source code
#+begin_src elisp
  (use-package emacs
    :ensure nil
    :demand
    :init
    ;; UTF-8 as the default coding system.
    (when (fboundp 'set-charset-priority)
      (set-charset-priority 'unicode))       ; pretty
    (prefer-coding-system 'utf-8)            ; pretty
    (setq locale-coding-system 'utf-8)       ; please
    (unless (eq system-type 'windows-nt)
      (setq selection-coding-system 'utf-8)) ; with sugar on top

    (fset #'display-startup-echo-area-message #'ignore)
    :hook
    ;; Favor hard-wrapping in text modes.
    (text-mode . auto-fill-mode)

    ;; Keep cursor from getting stuck in the read-only prompt
    (minibuffer-setup-hook . cursor-intangible-mode)

    :custom
    (use-file-dialog nil "File dialogs via minibuffer only.")
    (use-dialog-box nil "Dialogs via minibuffer only.")


    (truncate-lines t "Truncate long lines.")
    (truncate-partial-width-windows nil "Truncate lines without magic.")

    ;; Tab and Space. Permanently indent with spaces, never with TABs.
    (tab-width 4 "Sane default.")
    (indent-tabs-mode nil "Tabs are evil.")
    (fill-column 80 "Wrap line at 80.")

    (delete-by-moving-to-trash t "Deleting files go to OS's trash folder.")

    (ffap-machine-p-known 'reject "Don't ping.")

    ;; Menu/Tool/Scroll bars
    (hscroll-step 1 "How many colums scroll when points get too close to the edge.")
    (scroll-step 1 "How many lines scroll when point moves out.")
    (scroll-margin 5 "Number of lines of margin at the top & bottom.")
    (scroll-conservatively 10 "Scroll up to this many lines.")
    (scroll-preserve-screen-position t)
    ;; Reduce cursor lag by a tiny bit by not auto-adjusting `window-vscroll'
    ;; for tall lines.
    (auto-window-vscroll nil)
    ;; More performant rapid scrolling over unfontified regions. May cause brief
    ;; spells of inaccurate fontification immediately after scrolling.
    (fast-but-imprecise-scrolling t)
    ;; Disable help mouse-overs for mode-line segments (i.e. :help-echo text).
    ;; They're generally unhelpful and only add confusing visual clutter.
    (mode-line-default-help-echo nil)
    (show-help-function nil)

    (visible-cursor nil "Don't make cursor very visible.")
    (visible-bell t "Flash frame to represent a bell.")

    ;; Try really hard to keep the cursor from getting stuck in the read-only prompt
    ;; portion of the minibuffer.
    (minibuffer-prompt-properties
     '(read-only t intangible t cursor-intangible t face minibuffer-prompt))

    (x-gtk-use-system-tooltips nil "Don't use GTK+ tooltip.")

    (window-resize-pixelwise t "Don't resize in steps.")
    (frame-resize-pixelwise t "Don't resize in steps.")

    (split-height-threshold nil "Favor vertical splits over horizontal ones.")

    (echo-keystrokes 0.02 "Echo key-sequence in minibuffer, like VIM does.")

    ;; Expand the minibuffer to fit multi-line text displayed in the echo-area. This
    ;; doesn't look too great with direnv, however...
    (resize-mini-windows 'grow-only)
    ;; But don't let the minibuffer grow beyond this size
    (max-mini-window-height 0.15)

    (x-underline-at-descent-line t "Underline looks a bit better when drawn lower.")

    (indicate-empty-lines t "Visually indicate empty lines.")
    (indicate-buffer-boundaries 'left "Show buffer boundaries at left fringe.")

    ;; Display the bare minimum at startup. We don't need all that noise.
    ;; The dashboard/empty scratch buffer is good enough.
    (inhibit-default-init t "Don't load default font family.")
    (inhibit-startup-screen t "Don't show startup screen.")
    (inhibit-startup-echo-area-message t "Don't echo messages.")
    (inhibit-splash-screen t "Don't show the splash screen.")
    (initial-scratch-message nil "Disable initial scratch message.")
    (initial-major-mode 'text-mode "It just text by default.")

    (history-length 1000 "Max length of history lists.")
    (history-delete-duplicates t "Delete dups in history."))
#+end_src

** Files
Files, backups, etc.

#+begin_src elisp
  (use-package files
    :ensure nil
    :defer t
    :preface
    (defun my-backup-enable-predicate (name)
      "Like 'normal-backup-enable-predicate but checks var directory too."
      (if (string-prefix-p no-littering-var-directory name)
          nil
        (normal-backup-enable-predicate name)))

    :config
    ;; Backups
    (setq backup-enable-predicate #'my-backup-enable-predicate)

    ;; Don't kill *Scratch*!
    (with-current-buffer
        (get-buffer "*scratch*")
      (add-hook 'kill-buffer-hook
                (lambda () (error "DENIED! don't kill my *scratch*!"))
                nil t))

    :custom
    (confirm-kill-processes nil "Kill process without confirmation.")
    (require-final-newline t "Add new line at EOF.")
    (confirm-nonexistent-file-or-buffer t "Confirm before visiting a new file or buffer.")

    (delete-old-versions -1 "Prevents any trimming of backup versions.")
    (version-control t "Make numeric backup versions unconditionally.")
    (vc-make-backup-files t "Backups of registered files are made as with other files.")
    (backup-by-copying t "Don't clobber symlinks.")

    (auto-save-file-name-transforms
     `((".*" ,(no-littering-expand-var-file-name "auto-save/") t))
     "Transforms to apply to buffer file name before auto-save."))
#+end_src

** Save place
Point goes to the last place where it was when you previously visited the same file.

#+begin_src elisp
  (use-package saveplace
    :ensure nil
    :defer t
    :config
    (save-place-mode 1))
#+end_src
** Advice
Disable warnings from legacy advice system. They aren't useful, and we can't
often do anything about them besides changing packages upstream.

#+begin_src elisp
  (use-package advice
    :ensure nil
    :defer t
    :custom
    (ad-redefinition-action 'accept "Disable warnings."))
#+end_src
** Apropos
Make apropos omnipotent. It's more useful this way.

#+begin_src elisp
  (use-package apropos
    :ensure nil
    :defer t
    :custom
    (apropos-do-all t "Make apropos omnipotent."))
#+end_src
** Recent files
Exclude some files from =recentf= lists and save list on save and some times on timer.

#+begin_src elisp
  (use-package recentf
    :ensure nil
    :hook (after-init . recentf-mode)
    :init
    ;; Save recent list some times
    (run-at-time t (* 5 60) 'recentf-save-list)
    :custom
    (recentf-max-saved-items 200 "Many-many items in recent list.")
    (recentf-exclude
     '("\\.?cache"
       "url"
       "COMMIT_EDITMSG\\'"
       "bookmarks"
       "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\)$"
       "^/tmp/"
       "^/ssh:"
       "\\.?ido\\.last$"
       "\\.revive$"
       "/TAGS$"
       (lambda (file) (file-in-directory-p file package-user-dir))
       (expand-file-name recentf-save-file)
       no-littering-var-directory
       no-littering-etc-directory) "Excludes from recent list."))
#+end_src
** Save history
#+begin_src elisp
  (use-package savehist
    :ensure nil
    :hook (after-init . savehist-mode)
    :custom
    (enable-recursive-minibuffers t "Allow minibuffer commands while in minibuffer.")
    (savehist-additional-variables
     '(mark-ring
       global-mark-ring
       search-ring
       regexp-search-ring
       extended-command-history) "Additional variables to save.")
    (savehist-autosave-interval 300 "Save history sometime."))
#+end_src
** Auto revert
Revert buffer of file change on disk.

#+begin_src elisp
  (use-package autorevert
    :ensure nil
    :diminish
    :hook (after-init . global-auto-revert-mode)
    :custom
    (auto-revert-check-vc-info t "Update version control.")
    (auto-revert-verbose nil "Silent auto revert."))
#+end_src
** Desktop save and load
Restore last autosaved session.

#+begin_src elisp
  (use-package desktop
    :ensure nil
    :hook
    ;; Must be loaded after 'doom-modeline
    ;; See: https://github.com/seagle0128/doom-modeline/issues/216
    (doom-modeline-mode . desktop-revert)
    :custom
    (desktop-restore-eager 10 "Restore immediately last N buffers.")
    (desktop-lazy-verbose nil "Be silent.")
    :config
    (setq desktop-save-mode t))
#+end_src
** Persistent Scratch buffer
Save *scratch* buffer content.

#+begin_src elisp
  (use-package persistent-scratch
    :hook (after-init . persistent-scratch-autosave-mode)
    :config
    (persistent-scratch-setup-default))
#+end_src
** Customization
#+begin_src elisp
  (use-package cus-edit
    :ensure nil
    :custom
    (custom-file (no-littering-expand-etc-file-name "custom.el"))
    :config
    (load custom-file nil t))
#+end_src
* GUI
** Mouse
#+begin_src elisp
  (use-package mouse
    :ensure nil
    :defer t
    :custom
    (mouse-yank-at-point t "Yanks at point instead of click."))
#+end_src

Mouse wheel settings.

#+begin_src elisp
  (use-package mwheel
    :ensure nil
    :defer t
    :custom
    (mouse-wheel-scroll-amount '(1 ((shift) . 5)) "Amount of scroll by mouse wheel.")
    (mouse-wheel-progressive-speed nil "Progressive scrolling."))
#+end_src
** Tooltips
Don't display floating tooltips; display their contents in the echo-area.

#+begin_src elisp
  (use-package tooltip
    :ensure nil
    :defer t
    :custom
    (tooltip-mode nil))
#+end_src
** Frame
#+begin_src elisp
  (use-package frame
    :ensure nil
    :hook
    ;; Display dividers between windows
    (window-setup . window-divider-mode)
    :custom
    (menu-bar-mode nil "No menu bar.")
    (tool-bar-mode nil "No tool bar.")
    (scroll-bar-mode nil "No scroll bar.")
    (blink-cursor-mode nil "Don't blink the cursor.")
    ;; Display dividers between windows
    (window-divider-default-places t "Dividers on the bottom and on the right.")
    (window-divider-default-bottom-width 1)
    (window-divider-default-right-width 1))
#+end_src
** Winner mode
Restore old window configurations.

#+begin_src elisp
  (use-package winner
    :ensure nil
    :commands (winner-undo winner-redo)
    :hook (after-init . winner-mode)
    :custom
    (winner-boring-buffers '("*Apropos*"
                             "*Buffer List*"
                             "*Compile-Log*"
                             "*Completions*"
                             "*Fuzzy Completions*"
                             "*Help*"
                             "*Ibuffer*"
                             "*cvs*"
                             "*esh command on file*"
                             "*inferior-lisp*")))
#+end_src
** Doom theme
Setup Doom themes (use One Dark), set font face.

#+begin_src elisp
  (use-package doom-themes
    :custom-face (default ((t (:family "FuraCode Nerd Font Mono" :height 120))))
    :defines doom-themes-treemacs-theme
    :functions doom-themes-hide-modeline
    :init (load-theme 'doom-one t)
    :custom
    (doom-themes-treemacs-theme "doom-colors")
    :config
    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config)

    ;; Enable customized theme (`all-the-icons' must be installed!)
    (doom-themes-treemacs-config)
    (with-eval-after-load 'treemacs
      (remove-hook 'treemacs-mode-hook #'doom-themes-hide-modeline)))
#+end_src
** Modeline
Use Doom modeline.

#+begin_src elisp
  (use-package doom-modeline
    :hook (after-init . doom-modeline-mode)
    :custom
    (doom-modeline-minor-modes t "Display minor modes.")
    (doom-modeline-unicode-fallback t "Use unicode when no icons."))
#+end_src

Hide minor modes to menu.

#+begin_src elisp
  (use-package minions
    :hook (doom-modeline-mode . minions-mode))
#+end_src

Nyan Mode is an analog indicator of your position in the buffer.

#+begin_src elisp
  (use-package nyan-mode
    :diminish nyan-mode
    :hook (after-init . nyan-mode)
    :custom (nyan-bar-length 16 "Bar length."))
#+end_src

Hide modeline when needed.

#+begin_src elisp
  (use-package hide-mode-line
    :hook
    ;; Hide mode-line for completion list
    ((completion-list-mode completion-in-region-mode) . hide-mode-line-mode))
  #+end_src
** Solaire mode
Visually distinguish file-visiting windows from other types of windows.

#+begin_src elisp
  (use-package solaire-mode
    :hook
    (((change-major-mode after-revert ediff-prepare-buffer) . turn-on-solaire-mode)
     (minibuffer-setup . solaire-mode-in-minibuffer)
     (after-load-theme . solaire-mode-swap-bg))
    :custom
    (solaire-mode-remap-fringe nil "Don't colorize fringe.")
    :config
    (solaire-mode-swap-bg))
#+end_src
** Evil goggles
Displays a visual hint when editing with evil.

#+begin_src elisp
  (use-package evil-goggles
    :diminish evil-goggles-mode
    :after evil
    :defer 2
    :config
    (evil-goggles-mode)
    (evil-goggles-use-diff-faces))
#+end_src
* Autocomplete
** Prescient
Library which sorts and filters lists of candidates.

#+begin_src elisp
  (use-package prescient
    :commands prescient-persist-mode
    :after counsel
    :hook (ivy-mode . prescient-persist-mode)
    :custom
    (prescient-filter-method '(literal regexp initialism fuzzy)
                             "How to interpret filtering queries."))
#+end_src
** Ivy / Counsel / Swiper stack
*** Ivy
A generic completion frontend.

#+begin_src elisp
  (use-package ivy
    :diminish ivy-mode
    :hook (after-init . ivy-mode)
    :preface
    (defun my-ivy-format-function-arrow (cands)
      "Transform CANDS into a string for minibuffer."
      (ivy--format-function-generic
       (lambda (str)
         (concat (if (display-graphic-p)
                     (all-the-icons-octicon "chevron-right" :height 0.8 :v-adjust -0.05)
                   ">")
                 (propertize " " 'display `(space :align-to 2))
                 (ivy--add-face str 'ivy-current-match)))
       (lambda (str)
         (concat (propertize " " 'display `(space :align-to 2)) str))
       cands
       "\n"))
    :custom
    (ivy-use-selectable-prompt t "Make the prompt line selectable like a candidate.")
    (ivy-use-virtual-buffers t "Add recent files/bookmarks to ivy-switch-buffer.")
    (ivy-height 15 "Number of lines for the minibuffer window.")
    (ivy-fixed-height-minibuffer t "Fix the height of minibuffer during completion.")
    (ivy-count-format "(%d/%d)" "index/count format.")
    (ivy-on-del-error-function nil "Do nothing on backward delete error.")
    (ivy-initial-inputs-alist nil)
    (ivy-format-functions-alist
     '((counsel-describe-face . counsel--faces-format-function)
       (t . my-ivy-format-function-arrow))
     "Functions that transform the list of candidates into string."))
#+end_src
*** Ivy prescient
Better sorting and filtering for Ivy.

#+begin_src elisp
  (use-package ivy-prescient
    :commands ivy-prescient-re-builder
    :after (prescient)
    :hook (ivy-mode . ivy-prescient-mode)
    :custom-face
    (ivy-minibuffer-match-face-1 ((t (:inherit font-lock-doc-face :foreground nil))))
    :preface
    (defun ivy-prescient-non-fuzzy (str)
      (let ((prescient-filter-method '(literal regexp)))
        (ivy-prescient-re-builder str)))
    :custom
    (ivy-prescient-retain-classic-highlighting t "Emulate the Ivy highlights candidates.")
    (ivy-re-builders-alist '((counsel-rg . ivy-prescient-non-fuzzy)
                             (counsel-pt . ivy-prescient-non-fuzzy)
                             (counsel-grep . ivy-prescient-non-fuzzy)
                             (counsel-imenu . ivy-prescient-non-fuzzy)
                             (counsel-projectile-grep . ivy-prescient-non-fuzzy)
                             (counsel-projectile-rg . ivy-prescient-non-fuzzy)
                             (counsel-yank-pop . ivy-prescient-non-fuzzy)
                             (projectile-grep . ivy-prescient-non-fuzzy)
                             (projectile-ripgrep . ivy-prescient-non-fuzzy)
                             (swiper . ivy-prescient-non-fuzzy)
                             (swiper-isearch . ivy-prescient-non-fuzzy)
                             (swiper-all . ivy-prescient-non-fuzzy)
                             (lsp-ivy-workspace-symbol . ivy-prescient-non-fuzzy)
                             (lsp-ivy-global-workspace-symbol . ivy-prescient-non-fuzzy)
                             (insert-char . ivy-prescient-non-fuzzy)
                             (counsel-unicode-char . ivy-prescient-non-fuzzy)
                             (t . ivy-prescient-re-builder))
                           "A list of regex building funcs for each collection func.")
    (ivy-prescient-sort-commands
     '(:not swiper swiper-isearch ivy-switch-buffer
            counsel-grep counsel-git-grep counsel-ag counsel-imenu
            counsel-yank-pop counsel-recentf counsel-buffer-or-recentf)
     "Which commands have their candidates sorted by prescient."))
#+end_src
*** Counsel
Collection of Ivy-enhanced versions of common Emacs commands.

#+begin_src elisp
  (use-package counsel
    :diminish counsel-mode
    :after (ivy-prescient)
    :hook (ivy-mode . counsel-mode)
    :custom
    (counsel-find-file-at-point t "" "Add file-at-point to the list of candidates.")
    (counsel-yank-pop-separator
     "\n────────\n" "Separator for kill rings in counsel-yank-pop.")
    (counsel-grep-base-command
     (if (executable-find "rg")
         "rg -S --no-heading --line-number --color never '%s' %s"
       "grep -E -n -e %s %s")
     "Use the faster search tool: ripgrep."))
#+end_src
*** Swiper
isearch alternative.

#+begin_src elisp
  (use-package swiper
    :custom
    (swiper-action-recenter t "Recenter after exiting swiper."))
#+end_src
*** Ivy rich
More friendly display transformer for Ivy.
TODO: Minimize when PR merged https://github.com/melpa/melpa/pull/6669

#+begin_src elisp
  (use-package ivy-rich
    :after (:all (ivy counsel-projectile all-the-icons))
    :hook ((counsel-projectile-mode . ivy-rich-mode) ; Must load after `counsel-projectile'
           (ivy-rich-mode . (lambda ()
                              (setq ivy-virtual-abbreviate
                                    (or (and ivy-rich-mode 'abbreviate) 'name)))))
    :preface
    (with-no-warnings
      (defun ivy-rich-bookmark-name (candidate)
        (car (assoc candidate bookmark-alist)))

      (defun ivy-rich-buffer-icon (candidate)
        "Display buffer icons in `ivy-rich'."
        (when (display-graphic-p)
          (let* ((buffer (get-buffer candidate))
                 (buffer-file-name (buffer-file-name buffer))
                 (major-mode (buffer-local-value 'major-mode buffer))
                 (icon (with-current-buffer buffer (all-the-icons-icon-for-buffer))))
            (if (symbolp icon)
                (all-the-icons-faicon "file-o" :face 'all-the-icons-dsilver :height 0.8 :v-adjust 0.0)
              icon))))

      (defun ivy-rich-file-icon (candidate)
        "Display file icons in `ivy-rich'."
        (when (display-graphic-p)
          (let* ((path (concat ivy--directory candidate))
                 (file (file-name-nondirectory path))
                 (icon (cond
                        ((file-directory-p path)
                         (all-the-icons-icon-for-dir path nil ""))
                        ((string-match "^/.*:$" path)
                         (all-the-icons-octicon "radio-tower" :height 1.0 :v-adjust 0.01))
                        ((not (string-empty-p file))
                         (all-the-icons-icon-for-file file :v-adjust -0.05)))))
            (if (symbolp icon)
                (all-the-icons-faicon "file-o" :face 'all-the-icons-dsilver :height 0.8 :v-adjust 0.0)
              icon))))

      (defun ivy-rich-project-icon (_candidate)
        "Display project icons in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-octicon "file-directory" :height 1.0 :v-adjust 0.01)))

      (defun ivy-rich-mode-icon (_candidate)
        "Display mode icons in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "cube" :height 0.95 :v-adjust -0.05 :face 'all-the-icons-blue)))

      (defun ivy-rich-function-icon (_candidate)
        "Display function icons in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "cube" :height 0.95 :v-adjust -0.05 :face 'all-the-icons-purple)))

      (defun ivy-rich-variable-icon (_candidate)
        "Display the variable icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-octicon "tag" :height 0.95 :v-adjust 0 :face 'all-the-icons-lblue)))

      (defun ivy-rich-symbol-icon (_candidate)
        "Display the symbol icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-octicon "gear" :height 0.9 :v-adjust -0.05)))

      (defun ivy-rich-theme-icon (_candidate)
        "Display the theme icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-material "palette" :height 1.0 :v-adjust -0.2)))

      (defun ivy-rich-keybinding-icon (_candidate)
        "Display the keybindings icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-material "keyboard" :height 0.9 :v-adjust -0.15)))

      (defun ivy-rich-library-icon (_candidate)
        "Display the library icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-material "view_module" :height 1.0 :v-adjust -0.225 :face 'all-the-icons-lblue)))

      (defun ivy-rich-package-icon (_candidate)
        "Display the package icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "archive" :height 0.9 :v-adjust -0.05 :face 'all-the-icons-silver)))

      (defun ivy-rich-font-icon (_candidate)
        "Display the font icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "font" :height 0.85 :v-adjust -0.05 :face 'all-the-icons-lblue)))

      (defun ivy-rich-world-clock-icon (_candidate)
        "Display the world clock icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "globe" :height 0.9 :v-adjust -0.05 :face 'all-the-icons-lblue)))

      (defun ivy-rich-tramp-icon (_candidate)
        "Display the tramp icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-octicon "radio-tower" :height 0.9 :v-adjust 0.01)))

      (defun ivy-rich-git-branch-icon (_candidate)
        "Display the git branch icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-octicon "git-branch" :height 1.0 :v-adjust -0.05 :face 'all-the-icons-green)))

      (defun ivy-rich-process-icon (_candidate)
        "Display the process icon in `ivy-rich'."
        (when (display-graphic-p)
          (all-the-icons-faicon "bolt" :height 1.0 :v-adjust -0.05 :face 'all-the-icons-lblue)))

      (defun ivy-rich-imenu-icon (candidate)
        "Display the imenu icon in `ivy-rich'."
        (when (display-graphic-p)
          (let ((case-fold-search nil))
            (cond
             ((string-match-p "Type Parameters?[:)]" candidate)
              (all-the-icons-faicon "arrows" :height 0.85 :v-adjust -0.05))
             ((string-match-p "\\(Variables?\\)\\|\\(Fields?\\)\\|\\(Parameters?\\)[:)]" candidate)
              (all-the-icons-octicon "tag" :height 0.95 :v-adjust 0 :face 'all-the-icons-lblue))
             ((string-match-p "Constants?[:)]" candidate)
              (all-the-icons-faicon "square-o" :height 0.95 :v-adjust -0.15))
             ((string-match-p "Enum\\(erations?\\)?[:)]" candidate)
              (all-the-icons-material "storage" :height 0.95 :v-adjust -0.2 :face 'all-the-icons-orange))
             ((string-match-p "References?[:)]" candidate)
              (all-the-icons-material "collections_bookmark" :height 0.95 :v-adjust -0.2))
             ((string-match-p "\\(Types?\\)\\|\\(Property\\)[:)]" candidate)
              (all-the-icons-faicon "wrench" :height 0.9 :v-adjust -0.05))
             ((string-match-p "\\(Functions?\\)\\|\\(Methods?\\)\\|\\(Constructors?\\)[:)]" candidate)
              (all-the-icons-faicon "cube" :height 0.95 :v-adjust -0.05 :face 'all-the-icons-purple))
             ((string-match-p "\\(Class\\)\\|\\(Structs?\\)[:)]" candidate)
              (all-the-icons-material "settings_input_component" :height 0.9 :v-adjust -0.15 :face 'all-the-icons-orange))
             ((string-match-p "Interfaces?[:)]" candidate)
              (all-the-icons-material "share" :height 0.95 :v-adjust -0.2 :face 'all-the-icons-lblue))
             ((string-match-p "Modules?[:)]" candidate)
              (all-the-icons-material "view_module" :height 0.95 :v-adjust -0.15 :face 'all-the-icons-lblue))
             ((string-match-p "Packages?[:)]" candidate)
              (all-the-icons-faicon "archive" :height 0.9 :v-adjust -0.05 :face 'all-the-icons-silver))
             (t (all-the-icons-material "find_in_page" :height 0.9 :v-adjust -0.125))))))

      (when (display-graphic-p)
        (defun my-ivy-rich-bookmark-type (candidate)
          (let ((filename (ivy-rich-bookmark-filename candidate)))
            (cond ((null filename)
                   (all-the-icons-material "block" :height 1.0 :v-adjust -0.2 :face 'warning))  ; fixed #38
                  ((file-remote-p filename)
                   (all-the-icons-octicon "radio-tower" :height 0.9 :v-adjust 0.01))
                  ((not (file-exists-p filename))
                   (all-the-icons-material "block" :height 1.0 :v-adjust -0.2 :face 'error))
                  ((file-directory-p filename)
                   (all-the-icons-octicon "file-directory" :height 0.9 :v-adjust -0.05))
                  (t (all-the-icons-icon-for-file (file-name-nondirectory filename) :height 0.9 :v-adjust -0.05)))))
        (advice-add #'ivy-rich-bookmark-type :override #'my-ivy-rich-bookmark-type)))
    :init
    ;; Setting tab size to 1, to insert tabs as delimiters
    (add-hook 'minibuffer-setup-hook
              (lambda ()
                (setq tab-width 1)))
    :custom
    (ivy-rich-parse-remote-buffer nil "For better performance.")
    (ivy-rich-display-transformers-list
     '(ivy-switch-buffer
       (:columns
        ((ivy-rich-buffer-icon)
         (ivy-rich-candidate (:width 30))
         (ivy-rich-switch-buffer-size (:width 7))
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
         (ivy-rich-switch-buffer-project (:width 15 :face success))
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        :predicate
        (lambda (cand) (get-buffer cand))
        :delimiter "\t")
       ivy-switch-buffer-other-window
       (:columns
        ((ivy-rich-buffer-icon)
         (ivy-rich-candidate (:width 30))
         (ivy-rich-switch-buffer-size (:width 7))
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
         (ivy-rich-switch-buffer-project (:width 15 :face success))
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        :predicate
        (lambda (cand) (get-buffer cand))
        :delimiter "\t")
       counsel-switch-buffer
       (:columns
        ((ivy-rich-buffer-icon)
         (ivy-rich-candidate (:width 30))
         (ivy-rich-switch-buffer-size (:width 7))
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
         (ivy-rich-switch-buffer-project (:width 15 :face success))
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        :predicate
        (lambda (cand) (get-buffer cand))
        :delimiter "\t")
       counsel-switch-buffer-other-window
       (:columns
        ((ivy-rich-buffer-icon)
         (ivy-rich-candidate (:width 30))
         (ivy-rich-switch-buffer-size (:width 7))
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
         (ivy-rich-switch-buffer-project (:width 15 :face success))
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        :predicate
        (lambda (cand) (get-buffer cand))
        :delimiter "\t")
       persp-switch-to-buffer
       (:columns
        ((ivy-rich-buffer-icon)
         (ivy-rich-candidate (:width 30))
         (ivy-rich-switch-buffer-size (:width 7))
         (ivy-rich-switch-buffer-indicators (:width 4 :face error :align right))
         (ivy-rich-switch-buffer-major-mode (:width 12 :face warning))
         (ivy-rich-switch-buffer-project (:width 15 :face success))
         (ivy-rich-switch-buffer-path (:width (lambda (x) (ivy-rich-switch-buffer-shorten-path x (ivy-rich-minibuffer-width 0.3))))))
        :predicate
        (lambda (cand) (get-buffer cand))
        :delimiter "\t")
       counsel-M-x
       (:columns
        ((ivy-rich-function-icon)
         (counsel-M-x-transformer (:width 50))
         (ivy-rich-counsel-function-docstring (:face font-lock-doc-face))))
       counsel-describe-function
       (:columns
        ((ivy-rich-function-icon)
         (counsel-describe-function-transformer (:width 50))
         (ivy-rich-counsel-function-docstring (:face font-lock-doc-face))))
       counsel-describe-variable
       (:columns
        ((ivy-rich-variable-icon)
         (counsel-describe-variable-transformer (:width 50))
         (ivy-rich-counsel-variable-docstring (:face font-lock-doc-face))))
       counsel-set-variable
       (:columns
        ((ivy-rich-variable-icon)
         (counsel-describe-variable-transformer (:width 50))
         (ivy-rich-counsel-variable-docstring (:face font-lock-doc-face))))
       counsel-apropos
       (:columns
        ((ivy-rich-symbol-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-info-lookup-symbol
       (:columns
        ((ivy-rich-symbol-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-descbinds
       (:columns
        ((ivy-rich-keybinding-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-find-file
       (:columns
        ((ivy-rich-file-icon)
         (ivy-read-file-transformer))
        :delimiter "\t")
       counsel-file-jump
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-dired
       (:columns
        ((ivy-rich-file-icon)
         (ivy-read-file-transformer))
        :delimiter "\t")
       counsel-dired-jump
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-el
       (:columns
        ((ivy-rich-symbol-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-fzf
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-git
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-recentf
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate (:width 0.8))
         (ivy-rich-file-last-modified-time (:face font-lock-comment-face)))
        :delimiter "\t")
       counsel-buffer-or-recentf
       (:columns
        ((ivy-rich-file-icon)
         (counsel-buffer-or-recentf-transformer (:width 0.8))
         (ivy-rich-file-last-modified-time (:face font-lock-comment-face)))
        :delimiter "\t")
       counsel-bookmark
       (:columns
        ((ivy-rich-bookmark-type)
         (ivy-rich-bookmark-name (:width 40))
         (ivy-rich-bookmark-info))
        :delimiter "\t")
       counsel-bookmarked-directory
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-package
       (:columns
        ((ivy-rich-package-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-fonts
       (:columns
        ((ivy-rich-font-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-major
       (:columns
        ((ivy-rich-function-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-find-library
       (:columns
        ((ivy-rich-library-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-load-library
       (:columns
        ((ivy-rich-library-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-load-theme
       (:columns
        ((ivy-rich-theme-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-world-clock
       (:columns
        ((ivy-rich-world-clock-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-tramp
       (:columns
        ((ivy-rich-tramp-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-git-checkout
       (:columns
        ((ivy-rich-git-branch-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-list-processes
       (:columns
        ((ivy-rich-process-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-projectile-switch-project
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-projectile-find-file
       (:columns
        ((ivy-rich-file-icon)
         (counsel-projectile-find-file-transformer))
        :delimiter "\t")
       counsel-projectile-find-dir
       (:columns
        ((ivy-rich-project-icon)
         (counsel-projectile-find-dir-transformer))
        :delimiter "\t")
       counsel-minor
       (:columns
        ((ivy-rich-mode-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       counsel-imenu
       (:columns
        ((ivy-rich-imenu-icon)
         (ivy-rich-candidate))
        :delimiter "\t")
       treemacs-projectile
       (:columns
        ((ivy-rich-file-icon)
         (ivy-rich-candidate))
        :delimiter "\t"))))
#+end_src
** Company
Modular in-buffer completion framework.

*** Core
#+begin_src elisp
  (use-package company
    :diminish company-mode
    :defines (company-dabbrev-ignore-case company-dabbrev-downcase)
    :commands company-abort
    :hook (prog-mode . company-mode)
    :bind
    (:map company-active-map
          ("M-RET" . company-complete-selection)
          ("M-q"   . company-other-backend))
    :custom
    (company-tooltip-align-annotations t "Align annotation to the right side.")
    (company-minimum-prefix-length 2 "Minimum prefix length for idle completion.")
    (company-idle-delay 0.2 "Idle delay in seconds before completion starts.")
    (company-show-numbers t "Number the candidates (use M-1, M-2 etc to select completions).")
    (company-eclim-auto-save nil "Stop eclim auto save.")
    (company-dabbrev-downcase nil "No downcase when completion.")
    (company-dabbrev-ignore-case nil "Ignore case when collection candidates.")
    (company-selection-wrap-around t "Selecting item <first|>last wraps around.")
    (company-global-modes
     '(not erc-mode message-mode help-mode gud-mode eshell-mode shell-mode)
     "Disable for some modes.")
    (company-global-modes nil)
    (company-backends '((company-capf company-files)) "Default list of active backends.")
    (company-frontends
     '(company-pseudo-tooltip-frontend company-echo-metadata-frontend)
     "List of active frontends.")
    :config
    (with-eval-after-load 'company-mode
      (add-to-list 'company-backends #'company-dabbrev-code)))
#+end_src
*** Company Prescient
Better sorting and filtering.

#+begin_src elisp
  (use-package company-prescient
    :hook (company-mode . company-prescient-mode))
#+end_src
*** Company Box
A company front-end with icons.

#+begin_src elisp
  (use-package company-box
    :diminish
    :if (display-graphic-p)
    :hook (company-mode . company-box-mode)
    :custom
    (company-box-enable-icon t "Display icons.")
    (company-box-show-single-candidate t "Display when only one candidate.")
    (company-box-max-candidates 50 "Maximum number of candidates.")
    :config
    (with-no-warnings
      ;; Highlight `company-common'
      (defun my-company-box--make-line (candidate)
        (-let* (((candidate annotation len-c len-a backend) candidate)
                (color (company-box--get-color backend))
                ((c-color a-color i-color s-color) (company-box--resolve-colors color))
                (icon-string (and company-box--with-icons-p (company-box--add-icon candidate)))
                (candidate-string (concat (propertize (or company-common "") 'face 'company-tooltip-common)
                                          (substring (propertize candidate 'face 'company-box-candidate)
                                                     (length company-common) nil)))
                (align-string (when annotation
                                (concat " " (and company-tooltip-align-annotations
                                                 (propertize " " 'display `(space :align-to (- right-fringe ,(or len-a 0) 1)))))))
                (space company-box--space)
                (icon-p company-box-enable-icon)
                (annotation-string (and annotation (propertize annotation 'face 'company-box-annotation)))
                (line (concat (unless (or (and (= space 2) icon-p) (= space 0))
                                (propertize " " 'display `(space :width ,(if (or (= space 1) (not icon-p)) 1 0.75))))
                              (company-box--apply-color icon-string i-color)
                              (company-box--apply-color candidate-string c-color)
                              align-string
                              (company-box--apply-color annotation-string a-color)))
                (len (length line)))
          (add-text-properties 0 len (list 'company-box--len (+ len-c len-a)
                                           'company-box--color s-color)
                               line)
          line))
      (advice-add #'company-box--make-line :override #'my-company-box--make-line)

      ;; Prettify icons
      (defun my-company-box-icons--elisp (candidate)
        (when (derived-mode-p 'emacs-lisp-mode)
          (let ((sym (intern candidate)))
            (cond ((fboundp sym) 'Function)
                  ((featurep sym) 'Module)
                  ((facep sym) 'Color)
                  ((boundp sym) 'Variable)
                  ((symbolp sym) 'Text)
                  (t . nil)))))
      (advice-add #'company-box-icons--elisp :override #'my-company-box-icons--elisp))

    (declare-function all-the-icons-faicon 'all-the-icons)
    (declare-function all-the-icons-material 'all-the-icons)
    (declare-function all-the-icons-octicon 'all-the-icons)
    (setq company-box-icons-all-the-icons
          `((Unknown . ,(all-the-icons-material "find_in_page" :height 0.85 :v-adjust -0.2))
            (Text . ,(all-the-icons-faicon "text-width" :height 0.8 :v-adjust -0.05))
            (Method . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.05 :face 'all-the-icons-purple))
            (Function . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.05 :face 'all-the-icons-purple))
            (Constructor . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.05 :face 'all-the-icons-purple))
            (Field . ,(all-the-icons-octicon "tag" :height 0.8 :v-adjust 0 :face 'all-the-icons-lblue))
            (Variable . ,(all-the-icons-octicon "tag" :height 0.8 :v-adjust 0 :face 'all-the-icons-lblue))
            (Class . ,(all-the-icons-material "settings_input_component" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-orange))
            (Interface . ,(all-the-icons-material "share" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-lblue))
            (Module . ,(all-the-icons-material "view_module" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-lblue))
            (Property . ,(all-the-icons-faicon "wrench" :height 0.8 :v-adjust -0.05))
            (Unit . ,(all-the-icons-material "settings_system_daydream" :height 0.85 :v-adjust -0.2))
            (Value . ,(all-the-icons-material "format_align_right" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-lblue))
            (Enum . ,(all-the-icons-material "storage" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-orange))
            (Keyword . ,(all-the-icons-material "filter_center_focus" :height 0.85 :v-adjust -0.2))
            (Snippet . ,(all-the-icons-material "format_align_center" :height 0.85 :v-adjust -0.2))
            (Color . ,(all-the-icons-material "palette" :height 0.85 :v-adjust -0.2))
            (File . ,(all-the-icons-faicon "file-o" :height 0.85 :v-adjust -0.05))
            (Reference . ,(all-the-icons-material "collections_bookmark" :height 0.85 :v-adjust -0.2))
            (Folder . ,(all-the-icons-faicon "folder-open" :height 0.85 :v-adjust -0.05))
            (EnumMember . ,(all-the-icons-material "format_align_right" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-lblue))
            (Constant . ,(all-the-icons-faicon "square-o" :height 0.85 :v-adjust -0.1))
            (Struct . ,(all-the-icons-material "settings_input_component" :height 0.85 :v-adjust -0.2 :face 'all-the-icons-orange))
            (Event . ,(all-the-icons-octicon "zap" :height 0.8 :v-adjust 0 :face 'all-the-icons-orange))
            (Operator . ,(all-the-icons-material "control_point" :height 0.85 :v-adjust -0.2))
            (TypeParameter . ,(all-the-icons-faicon "arrows" :height 0.8 :v-adjust -0.05))
            (Template . ,(all-the-icons-material "format_align_left" :height 0.85 :v-adjust -0.2)))
          company-box-icons-alist 'company-box-icons-all-the-icons))
#+end_src
* Help & manual
** Which key
Displays the key bindings following your currently entered incomplete command (a
prefix) in a popup.

#+begin_src elisp
  (use-package which-key
    :diminish which-key-mode
    :defer 2
    :general
    (general-leader
     ;; Show top level key bindings
     "hk" 'which-key-show-top-level
     ;; Show major mode key bindings
     "<f3>" 'which-key-show-major-mode
     ;; Show key bindings from any keymap
     "<f4>" 'which-key-show-full-keymap)
    :config
    (which-key-setup-side-window-right-bottom)
    (which-key-mode))
#+end_src
** Better help
#+begin_src elisp
  (use-package helpful
    :defer 2
    :bind
    (:map help-mode-map
          ("f" . #'helpful-callable)
          ("v" . #'helpful-variable)
          ("k" . #'helpful-key)
          ("F" . #'helpful-at-point)
          ("F" . #'helpful-function)
          ("C" . #'helpful-command))
    :custom
    ;; Ivy support
    (counsel-describe-function-function #'helpful-callable)
    (counsel-describe-variable-function #'helpful-variable))
#+end_src
* Navigation
** Avy
Jump to things in Emacs tree-style.

#+begin_src elisp
  (use-package avy
    :commands (avy-goto-word-1)
    :general
    (general-mmap
      "C-'" 'evil-avy-goto-char-timer
      "C-\"" 'evil-avy-goto-word-0))
#+end_src
* Buffer management
** Unique buffer names
#+begin_src elisp
  (use-package uniquify
    :ensure nil
    :custom
    (uniquify-buffer-name-style 'forward "bar/mumble/name"))
#+end_src
** ibuffer
Better buffer menu.

#+begin_src elisp
  (use-package ibuffer
    :ensure nil
    :functions (all-the-icons-icon-for-file
                all-the-icons-icon-for-mode
                all-the-icons-auto-mode-match?
                all-the-icons-faicon
                my-ibuffer-find-file)
    :commands (ibuffer-find-file
               ibuffer-current-buffer)
    :bind ([remap list-buffers] . ibuffer)
    :custom
    (ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))
                                    "Use for displaying filtering group names.")
    :config
    ;; Replace evil :ls etc
    (with-eval-after-load 'evil
      (evil-define-command evil-show-files ()
        "Shows the file-list."
        :repeat nil
        (ibuffer))
      (evil-ex-define-cmd "buffers" 'evil-show-files))

    ;; Intergrate counsel
    (with-eval-after-load 'counsel
      (defun my-ibuffer-find-file ()
        (interactive)
        (let ((default-directory (let ((buf (ibuffer-current-buffer)))
                                   (if (buffer-live-p buf)
                                       (with-current-buffer buf
                                         default-directory)
                                     default-directory))))
          (counsel-find-file default-directory)))
      (advice-add #'ibuffer-find-file :override #'my-ibuffer-find-file))

    ;; Display buffer icons on GUI
    (when (and (display-graphic-p) (require 'all-the-icons nil t))
      ;; For alignment, the size of the name field should be the width of an icon
      (define-ibuffer-column icon (:name "  ")
        (let ((icon (if (and (buffer-file-name)
                             (all-the-icons-auto-mode-match?))
                        (all-the-icons-icon-for-file (file-name-nondirectory (buffer-file-name)) :v-adjust -0.05)
                      (all-the-icons-icon-for-mode major-mode :v-adjust -0.05))))
          (if (symbolp icon)
              (setq icon (all-the-icons-faicon "file-o" :face 'all-the-icons-dsilver :height 0.8 :v-adjust 0.0))
            icon)))

      (setq ibuffer-formats `((mark modified read-only ,(if (>= emacs-major-version 26) 'locked "")
                                    ;; Here you may adjust by replacing :right with :center or :left
                                    ;; According to taste, if you want the icon further from the name
                                    " " (icon 2 2 :left :elide)
                                    ,(propertize " " 'display `(space :align-to 8))
                                    (name 18 18 :left :elide)
                                    " " (size 9 -1 :right)
                                    " " (mode 16 16 :left :elide) " " filename-and-process)
                              (mark " " (name 16 -1) " " filename)))))
#+end_src

Group ibuffer's list by project root.

#+begin_src elisp
  (use-package ibuffer-projectile
    :functions all-the-icons-octicon ibuffer-do-sort-by-alphabetic
    :hook ((ibuffer . (lambda ()
                        (ibuffer-projectile-set-filter-groups)
                        (unless (eq ibuffer-sorting-mode 'alphabetic)
                          (ibuffer-do-sort-by-alphabetic)))))
    :custom
    (ibuffer-projectile-prefix
     (if (display-graphic-p)
         (concat
          (all-the-icons-octicon "file-directory"
                                 :face ibuffer-filter-group-name-face
                                 :v-adjust -0.05
                                 :height 1.25)
          " ")
       "Project: "))
    (initial-buffer-choice '(lambda ()
                              (ibuffer)
                              (get-buffer "*Ibuffer*"))
                           "Show list of buffers on startup.")
    :config
    (add-to-list 'ibuffer-never-show-predicates "^\\*helpful"))
#+end_src
* Project management
** Projectile
Manage and navigate projects.

#+begin_src elisp
  (use-package projectile
    :diminish projectile-mode
    :hook (after-init . projectile-mode)
    :general
    (general-leader
      "p" '(:keymap projectile-command-map :package projectile))
    :custom
    (projectile-mode-line-prefix "" "Mode line lighter prefix for Projectile.")
    (projectile-sort-order 'recentf "Sort order.")
    (projectile-use-git-grep t "Use git grep in git projects.")
    (projectile-enable-cache t)
    (projectile-completion-system 'ivy "Ivy integration.")
    :config
    ;; Update mode-line at the first time
    (projectile-update-mode-line))
#+end_src
** Projectile Ivy integration
More advanced Ivy integration.

#+begin_src elisp
  (use-package counsel-projectile
    :after (projectile)
    :hook (after-init . counsel-projectile-mode)
    :custom
    (counsel-projectile-rg-initial-input
     '(projectile-symbol-or-selection-at-point)
     "Initial minibuffer input.")
    :config
    (define-obsolete-function-alias 'counsel-more-chars 'ivy-more-chars "26.3"))
#+end_src
* File management
* Editing
** Simple
#+begin_src elisp
  (use-package simple
    :ensure nil
    :diminish visual-line-mode auto-fill-function
    :hook
    (window-setup . size-indication-mode)
    :config
    ;; Typing yes/no is obnoxious when y/n will do.
    (defalias #'yes-or-no-p #'y-or-n-p)
    :custom
    (column-number-mode t "Display column number in the mode line.")
    (line-number-mode t "Display line number in the mode line.")
    (line-move-visual nil "Keep cursor at end of lines.")
    (track-eol t "Vertical motion starting at EOF keeps to EOL.")
    (set-mark-command-repeat-pop t "Repeating C-SPC after popping mark pops it again.")

    ;; Eliminate duplicates in the kill ring. That is, if you kill the
    ;; same thing twice, you won't have to use M-y twice to get past it
    ;; to older entries in the kill ring.
    (kill-do-not-save-duplicates t "Don't add same string twice.")

    (save-interprogram-paste-before-kill
     t "Save clipboard contents into kill-ring before replacing them."))
#+end_src
** Delete selection
#+begin_src elisp
  (use-package delsel
    :ensure nil
    :custom
    (delete-selection-mode t "Replace the active region just by typing text."))
#+end_src
** Whitespaces
Delete trailing whitespaces on buffer save.

#+begin_src elisp
  (use-package whitespace
    :ensure nil
    :hook (before-save . whitespace-cleanup))
#+end_src
** Move visual block
Move selection up and down.

| key | mode   | command                   |
|-----+--------+---------------------------|
| =J= | visual | Move selected block up.   |
| =K= | visual | Move selected block down. |

#+begin_src elisp
  (general-vmap
    "J" (concat ":m '>+1" (kbd "RET") "gv=gv")
    "K" (concat ":m '<-2" (kbd "RET") "gv=gv"))
#+end_src
** On-the-fly spell checker
On the fly spell checking. Disabled by default. =hunspell= is must because of ability to query multiple dictionaries.

Related keybindings:
| key            | mode   | command                                                     |
|----------------+--------+-------------------------------------------------------------|
| =<leader> t S= | global | Toggle flyspell on/off                                      |
| =<leader> S b= | global | Spell check whole buffer.                                   |
| =z==           | normal | Correct previous word (ivy menu, access commands by =M-o=). |
| =[s=           | normal | Jump to the previous incorrect word.                        |
| =]s=           | normal | Jump to the next incorrect word.                            |

#+begin_src elisp
  (use-package flyspell
    :ensure nil
    :diminish
    :commands
    (flyspell-mode flyspell-prog-mode flyspell-buffer flyspell-correct-wrapper)
    :functions knopki/flyspell-or-flyspell-prog-mode
    :preface
    (defun knopki/flyspell-or-flyspell-prog-mode ()
      "Enable/disable flyspell-mode or flyspell-prog-mode"
      (interactive)
      (if (eq flyspell-mode nil)
          (if (derived-mode-p 'prog-mode) (flyspell-prog-mode) (flyspell-mode))
        (flyspell-mode-off)))
    :general
    (general-leader
      "t S" 'knopki/flyspell-or-flyspell-prog-mode
      "S b" 'flyspell-buffer)
    :if (executable-find "hunspell")
    :init
    (with-eval-after-load "ispell"
      (setq ispell-program-name "hunspell")
      (setq ispell-dictionary "en_US,ru_RU")
      (ispell-set-spellchecker-params)
      (ispell-hunspell-add-multi-dic "en_US,ru_RU"))
    :custom
    (flyspell-issue-message-flag nil "Be silent."))
#+end_src

Correcting words with flyspell via Ivy.
#+begin_src elisp
  (use-package flyspell-correct-ivy
    :after (:all (flyspell ivy))
    :init
    (setq flyspell-correct-interface #'flyspell-correct-ivy)
    :general
    ;; Redefine evil-mode keybinding
    ;; Also, use M-o to access ivy menu
    (general-nmap "z=" 'flyspell-correct-wrapper))
#+end_src
** Undo Tree
Treat undo history as a branching tree of changes.

#+begin_src elisp
  (use-package undo-tree
    :diminish
    :hook (after-init . global-undo-tree-mode)
    :general
    (general-leader
      "au" 'undo-tree-visualize)
    :custom
    (undo-tree-visualizer-timestamps t "Display timestamps.")
    (undo-tree-enable-undo-in-region nil "Do not undo changes only in region.")
    (undo-tree-visualizer-lazy-drawing 100 "Switch too lazy drawing after N nodes.")
    (undo-tree-auto-save-history t "Save history to file."))
#+end_src
* Productivity & task management
** Org mode
*** Core
#+begin_src elisp
  (use-package org
    :ensure nil
    :hook
    (org-mode . visual-line-mode)
    (org-mode . org-indent-mode)
    (org-indent-mode . (lambda () (diminish 'org-indent-mode)))
    :custom-face (org-ellipsis ((t (:foreground nil))))
    :general
    (general-leader
      "o a" 'org-agenda
      "o c" 'counsel-org-capture
      "o l" 'org-agenda-list
      "o s" 'org-search-view)
    :custom
    (org-modules '(org-checklist org-habit) "Always load modules.")

    (org-directory "~/org" "Directory with org files.")
    (org-log-done 'time "Record time when task moves to the DONE state.")
    (org-log-redeadline 'time "Record time when task deadline changes.")
    (org-log-reschedule 'time "Record time when task rescheduled.")
    (org-log-into-drawer t "Insert changes notes and time into a drawer.")
    (org-catch-invisible-edits 'smart "Check for invisible region before edit.")
    (org-startup-indented t "Turn on indent mode on startup.")
    (org-pretty-entities t "Show entities as UTF8 characters.")
    (org-src-window-setup 'current-window "Show edit buffer in the current window.")
    (org-enforce-todo-dependencies t "Undone tasks will block parent from DONE.")
    (org-enforce-todo-checkbox-dependencies t "Unchecked boxes will block parent from DONE.")
    (org-archive-location
     (concat org-directory "/archive/%s_archive::datetree/")
     "The location where subtree should be archived.")

    ;; Keywords
    (org-todo-keywords
     '((sequence "TODO(t!)" "NEXT(n)" "WIP(i!)" "WAITING(w@/!)"
                 "GAVE(g!)" "|" "DONE(d!)" "CANCELLED(c@/!)"))
     "List of keywords sequences and their interpretation.")
    (org-todo-keyword-faces
     '(("TODO"     . org-todo)
       ("NEXT"     . org-warning)
       ("WIP"      . (:foreground "OrangeRed" :weight bold))
       ("WAITING"  . (:foreground "coral" :weight bold))
       ("GAVE"     . (:foreground "LimeGreen" :weight bold))
       ("CANCELED" . org-done)
       ("DONE"     . org-done))
     "Faces for specific keywords.")

    ;; Priorities
    (org-lowest-priority ?D "The lowest priority of items.")
    (org-priority-faces '((?A . error)
                          (?B . warning)
                          (?C . success)
                          (?D . normal))
                        "Faces for specific Priorities.")

    ;; Tags
    (org-tags-exclude-from-inheritance
     '(olga)
     "List of tags that should never be inherited.")

    ;; Agenda
    (org-agenda-files '("~/org") "The files to be used for agenda display.")
    (org-agenda-text-search-extra-files '('agenda-archives) "Extra searched files.")
    (org-agenda-span 14 "Number of days to include in agenda overview.")
    (org-agenda-start-on-weekday nil "Start overview on today.")
    (org-agenda-start-day "-3d" "Show previous days in overview.")
    (org-agenda-skip-deadline-prewarning-if-scheduled
     t "Skip deadline prewarning when already scheduled.")
    (org-agenda-skip-scheduled-if-deadline-is-shown t "Skip scheduling line if deadline.")
    (org-agenda-include-diary t "Include diary entries like calendar.")
    (org-stuck-projects
     '("+projects/-DONE" ("NEXT" "WIP") ("@shop") "\\<IGNORE\\>")
     "How to identify stuck projects.")

    ;; Capture
    (org-default-notes-file
     (expand-file-name "capture.org" org-directory)
     "Default target for storing notes.")
    (org-capture-templates
     '(("t" "My TODO task" entry
        (file "capture.org")
        "* TODO  %?\nSCHEDULED: %t"))
     "Capture templates.")

    ;; Refile
    (org-refile-targets '((nil :maxlevel . 3)
                          (org-agenda-files :maxlevel . 3))
                        "Targets for refiling.")
    (org-refile-use-cache t "Cache refile targets.")

    ;; Attachments
    (org-attach-archive-delete file 'query "Ask for attachment delete on node delete.")

    ;; Clock
    (org-clock-persist 'history "Persist clock history.")

    ;; org-goto/ivy interplay hack
    (org-goto-interface 'outline-path-completion "For ivy integration.")
    (org-outline-path-complete-in-steps nil "For ivy integration.")

    ;; Babel
    (org-confirm-babel-evaluate nil "Evaluate babel without confirmation.")
    (org-src-fontify-natively t "Fontify code in code blocks.")
    (org-src-tab-acts-natively t "Indent on tab in code blocks like in code.")
    :config
    ;; Add new template
    (add-to-list 'org-structure-template-alist '("n" . "note"))

    ;; Autosave (no sure is it worth it)
    (run-with-idle-timer 30 t 'org-save-all-org-buffers)

    ;; Set up hooks for clock persistence.
    (org-clock-persistence-insinuate)


    (defvar load-language-list '((emacs-lisp . t)
                                 (shell . t)
                                 (python . t)
                                 (js . t)
                                 (css . t)))

    (org-babel-do-load-languages
     'org-babel-load-languages
     '((emacs-lisp . t)
       (shell . t)
       (js . t)
       (css . t)
       (python . t))))
#+end_src
*** Evil
Evil support in org-mode.

#+begin_src elisp
  (use-package evil-org
    :diminish
    :after (:all (org evil))
    :hook
    (org-mode . evil-org-mode)
    (evil-org-mode . (lambda () (evil-org-set-key-theme)))
    (org-agenda-mode . (lambda ()
                         (evil-org-mode)
                         (require 'evil-org-agenda)
                         (evil-org-agenda-set-keys)))
    :general
    (:keymaps 'org-src-mode-map [remap evil-write] 'org-edit-src-save)
    :custom
    (evil-org-key-theme
     '(navigation insert return textobjects additional shift todo heading calendar)
     "Key themes to enable.")
    (evil-org-retain-visual-state-on-shift t "<> should retain selection in visual mode."))
#+end_src
*** Org Bullets
Replace bullets with unicode characters.

#+begin_src elisp
  (use-package org-bullets
    :diminish
    :hook (org-mode . org-bullets-mode)
    :custom
    (org-ellipsis "…"))
#+end_src
*** Fancy Priorities
Displays org priorities as custom strings.

#+begin_src elisp
  (use-package org-fancy-priorities
    :diminish
    :hook (org-mode . org-fancy-priorities-mode)
    :custom
    (org-fancy-priorities-list
     (if (char-displayable-p ?⚡)
         '("⚡" "⬆" "⬇" "☕")
       '("HI" "MID" "LOW" "OPT"))))
#+end_src
*** Table of Contents
Generates an up-to-date table of contents in org files without exporting.

#+begin_src elisp
  (use-package toc-org
    :hook
    (org-mode . toc-org-mode)
    ;; In markdown too.
    (markdown-mode . toc-org-mode))
#+end_src
* Version Control
** diff-hl
Highlights uncommitted changes on the fringe.

#+begin_src elisp
  (use-package diff-hl
    :defer t
    :after magit
    :hook
    (prog-mode . diff-hl-mode)
    (org-mode . diff-hl-mode)
    (dired-mode . diff-hl-dired-mode)
    (magit-post-refresh . diff-hl-magit-post-refresh))
#+end_src
** Ediff
A comprehensive visual interface to diff & patch.

#+begin_src elisp
  (use-package ediff
    :ensure nil
    :hook
    ;; show org ediffs unfolded
    ((ediff-prepare-buffer . outline-show-all)
     ;; restore window layout when done
     (ediff-quit . winner-undo))

    :custom
    (ediff-window-setup-function 'ediff-setup-windows-multiframe))
#+end_src
** Magit
Awesome git frontend.

#+begin_src elisp
  (use-package magit
    :general
    (general-leader
      "g" 'magit-status)
    :custom
    (magit-diff-toggle-refine-hunk t "Show word-granularity differences within diff hunks.")
    (magit-prefer-remote-upstream t "Favor remote branches when reading upstream branch.")
    (magit-completing-read-function
     'ivy-completing-read "Called when requested user input."))

  ;; Make Magit Evil
  ;; TODO: remove me after merge of https://github.com/emacs-evil/evil-collection/pull/259
  (use-package evil-magit
    :after (:all (magit evil)))
#+end_src
** Magit TODO
Show source files' TODOs (and FIXMEs, etc) in Magit status buffer.

#+begin_src elisp
  (use-package magit-todos
    :commands (ivy-magit-todos)
    ;; TODO: add keybindings
    :hook (magit-mode . magit-todos-mode)
    ;; TODO: remove after evil-collection updated with fix
    :general
    (:keymaps '(magit-todos-section-map magit-todos-item-section-map)
              "jT" nil
              "jl" nil
              "j" nil))
#+end_src
** Git Time Machine
Walk through git revisions of a file.

#+begin_src elisp
  (use-package git-timemachine
    :commands (git-timemachine)
    ;; TODO: setup keybindings
    :custom-face
    (git-timemachine-minibuffer-author-face ((t (:inherit success))))
    (git-timemachine-minibuffer-detail-face ((t (:inherit warning))))
    :hook (before-revert . (lambda ()
                             (when (bound-and-true-p git-timemachine-mode)
                               (user-error "Cannot revert the timemachine buffer")))))
#+end_src
** Browse at remote
Open github/gitlab/bitbucket page.

#+begin_src elisp
  (use-package browse-at-remote
    :commands (browse-at-remote browse-at-remote-kill)
    :bind (:map vc-prefix-map
                ("B" . browse-at-remote)))
#+end_src
** Git related modes
#+begin_src elisp
  (use-package gitattributes-mode)
  (use-package gitconfig-mode)
  (use-package gitignore-mode)
#+end_src
* Coding
** Eldoc
#+begin_src elisp
  (use-package eldoc
    :ensure nil
    :diminish eldoc-mode
    :hook
    (prog-mode . eldoc-mode)
    :custom
    (global-eldoc-mode -1 "Disable global mode."))
#+end_src
** Tabify
Buffer re-tabbing.

#+begin_src elisp
  (use-package tabify
    :ensure nil
    :commands (tabify untabify)
    :config
    (setq tabify-regexp "^\t* [ \t]+"))
#+end_src
** Highlight matching parens
#+begin_src elisp
  (use-package paren
    :ensure nil
    :custom
    (show-paren-mode t "Enable show matching parens."))
#+end_src
** Automatic parenthesis pairing
#+begin_src elisp
  (use-package elec-pair
    :ensure nil
    :hook (prog-mode . electric-pair-mode)
    :custom
    (electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src
** Display line numbers
#+begin_src elisp
  (use-package display-line-numbers
    :ensure nil
    :hook (prog-mode . display-line-numbers-mode))
#+end_src
** Highlight TODOs
Highlight TODO and similar keywords in comments and strings.

#+begin_src elisp
  (use-package hl-todo
    :hook (prog-mode . hl-todo-mode))
#+end_src
** Evil commentary
=gc= operator, like =vim-commentary=.

#+begin_src elisp
  (use-package evil-commentary
    :after evil
    :bind (:map evil-normal-state-map
                ("gc" . evil-commentary)))
#+end_src
** Evil surround
Emulates =vim-surround=.

#+begin_src elisp
  (use-package evil-surround
    :after evil
    :commands
    (evil-surround-edit
     evil-Surround-edit
     evil-surround-region
     evil-Surround-region)
    :general
    (:states 'operator
             "s" 'evil-surround-edit
             "S" 'evil-Surround-edit)
    (:states 'visual
             "S" 'evil-surround-region
             "gS" 'evil-Surround-region))
#+end_src
** Aggressive Indent
Minor mode to aggressively keep your code always indented.

#+begin_src elisp
  (use-package aggressive-indent
    :diminish
    :hook ((after-init . global-aggressive-indent-mode)
           ;; FIXME: Disable in big files due to the performance issues
           ;; https://github.com/Malabarba/aggressive-indent-mode/issues/73
           (find-file . (lambda ()
                          (if (> (buffer-size) (* 3000 80))
                              (aggressive-indent-mode -1)))))
    :config
    ;; Disable in some modes
    (dolist (mode '(asm-mode web-mode html-mode css-mode go-mode prolog-inferior-mode))
      (push mode aggressive-indent-excluded-modes))

    ;; Disable in some commands
    (add-to-list 'aggressive-indent-protected-commands #'delete-trailing-whitespace t)

    ;; Be slightly less aggressive in C/C++/C#/Java/Swift
    (add-to-list
     'aggressive-indent-dont-indent-if
     '(and (or (derived-mode-p 'c-mode)
               (derived-mode-p 'c++-mode)
               (derived-mode-p 'csharp-mode)
               (derived-mode-p 'java-mode)
               (derived-mode-p 'swift-mode))
           (null (string-match "\\([;{}]\\|\\b\\(if\\|for\\|while\\)\\b\\)"
                               (thing-at-point 'line))))))
#+end_src
** Flycheck
On-the-fly syntax checker.

#+begin_src elisp
  (use-package flycheck
    :hook (after-init . global-flycheck-mode)
    :custom
    (flycheck-emacs-lisp-load-path 'inherit "Inherit load paths from Emacs.")
    (flycheck-global-modes
     '(not org-mode text-mode outline-mode fundamental-mode
           shell-mode eshell-mode term-mode vterm-mode)
     "Disable checking in some modes.")
    (flycheck-check-syntax-automatically
     '(idle-change mode-enabled save) "Run checks only on this events.")
    (flycheck-idle-change-delay 4 "Idle delay before run checks."))
#+end_src
** Snippets
=yasnippet= for snippets.

#+begin_src elisp
  (use-package yasnippet
    :diminish yas-minor-mode
    :hook (after-init . yas-global-mode))

  (use-package yasnippet-snippets
    :after yasnippet)
#+end_src

Integrate =yasnippet= into =ivy=.

#+begin_src elisp
  (use-package ivy-yasnippet
    :commands ivy-yasnippet--preview
    :general
    (general-leader "y" 'ivy-yasnippet)
    :config
    (advice-add #'ivy-yasnippet--preview :override #'ignore))
#+end_src
** direnv
Switch project environment on buffer switch. Sometimes switching is slow.

#+begin_src elisp
  (use-package direnv
    ;; Ensures that external dependencies are available before they are called.
    :hook
    ((find-file
      flycheck-before-syntax-check
      before-hack-local-variables) . direnv-update-environment)
    :custom
    (direnv-always-show-summary nil)
    :config
    (direnv-mode)
    (advice-add 'prog-mode :before #'direnv-update-environment))
#+end_src
** LSP
Language Server Protocol Support for Emacs

LSP mode keybindings:
| key     | command                     |
|---------+-----------------------------|
| =, s s= | Start server                |
| =, s r= | Restart server              |
| =, s q= | Shutdown server             |
| =, s d= | Describe session            |
| =, s D= | Disconnect                  |
|         |                             |
| =, = == | Format buffer               |
| =, = r= | Format region               |
|         |                             |
| =, F a= | Add folder                  |
| =, F r= | Remove folder               |
| =, F b= | Un-blacklist folder         |
|         |                             |
| =, T l= | Toggle lenses               |
| =, T L= | Toggle log io               |
| =, T h= | Toggle highlighting         |
| =, T s= | Toggle signatures           |
| =, T S= | Toggle sideline             |
| =, T d= | Toddle documentation popup  |
| =, T p= | Toggle signature help       |
| =, T f= | Toggle on type formatting   |
| =, T T= | Toggle treemacs integration |
|         |                             |
| =, g g= | Find definition             |
| =, g r= | Find references             |
| =, g i= | Find implementations        |
| =, g d= | Find declarations           |
| =, g t= | Find type definitions       |
| =, g h= | Call hierarchy              |
| =, g a= | Find symbol in workspace    |
| =, g M= | Show navigation menu        |
| =, g e= | Show flycheck errors        |
|         |                             |
| =, h h= | Describe symbol at point    |
| =, h s= | Signature help              |
| =, h g= | Doc popup                   |
|         |                             |
| =, r r= | Rename                      |
| =, r o= | Organize imports            |
|         |                             |
| =, a a= | Code actions                |
| =, a l= | Lens                        |
| =, a h= | Highlight symbol            |
|         |                             |
| =, G g= | Peek definitions            |
| =, G r= | Peek references             |
| =, G i= | Peek implementations        |
| =, G s= | Peek workspace symbol       |
| =, G N= | Peek jump backward          |
| =, G n= | Peek jump forward           |

#+begin_src elisp
  (use-package lsp-mode
    ;; TODO: enable after upgrade
    ;; :hook (lsp-mode . lsp-enable-which-key-integration)
    :commands (lsp lsp-deffered)
    :general
    ;; TODO: merge with =lsp-command-map= after upgrade
    (general-major-leader
      :keymaps 'lsp-mode-map
      ;; sessions
      "s"  '(nil :wk "Sessions")
      "ss" '(lsp :wk "Start server")
      "sr" '(lsp-workspace-restart :wk "Restart server")
      "sq" '(lsp-workspace-shutdown :wk "Shutdown server")
      "sd" '(lsp-describe-session :wk "Describe session")
      "sD" '(lsp-disconnect :wk "Disconnect")

      ;; formatting
      "="  '(nil :wk "Formatting")
      "==" '((lambda ()
                (interactive)
                (cond
                 ((derived-mode-p 'python-mode) (python-black-buffer))
                 (lsp-format-buffer))) :wk "Format buffer")
      "=r" '(lsp-format-region :wk "Format region")

      ;; folders
      "F"  '(nil :wk "Folders")
      "Fa" '(lsp-workspace-folders-add :wk "Add folder")
      "Fr" '(lsp-workspace-folders-remove :wk "Remove folder")
      "Fb" '(lsp-workspace-blacklist-remove :wk "Un-blacklist folder")

      ;; toggle
      "T"  '(nil :wk "Toggle")
      "Tl" '(lsp-lens-mode :wk "Toggle lenses")
      "TL" '(lsp-toggle-trace-io :wk "Toggle log io")
      "Th" '(lsp-toggle-symbol-highlight :wk "Toggle highlighting")
      "Ts" '(lsp-toggle-signature-auto-activate :wk "Toggle signature")
      "TS" '(lsp-ui-sideline-mode :wk "Toggle sideline")
      "Td" '(lsp-ui-doc-mode :wk "Toggle documentation popup")
      "Tp" '(lsp-signature-mode :wk "Toggle signature help")
      "Tf" '(lsp-toggle-on-type-formatting :wk "Toggle on type formatting")
      "TT" '(lsp-treemacs-sync-mode :wk "Toggle treemacs integration")

      ;; goto
      "g"  '(nil :wk "Go To")
      "gg" '(lsp-find-definition :wk "Find definition")
      "gr" '(lsp-find-references :wk "Find references")
      "gi" '(lsp-find-implementation :wk "Find implementations")
      "gd" '(lsp-find-declaration :wk "Find declarations")
      "gt" '(lsp-find-type-definition :wl "Find type definition")
      "gh" '(lsp-treemacs-call-hierarchy :wk "Call hierarchy")
      "ga" '(xref-find-apropos :wk "Find symbol in workspace")
      "gM" '(lsp-ui-imenu :wk "Show navigation menu")
      "ge" '(lsp-ui-flycheck-list :wk "Show flyckeck errors")

      ;; help
      "h"  '(nil :wk "Help")
      "hh" '(lsp-describe-thing-at-point :wk "Describe symbol at point")
      "hs" '(lsp-signature-activate :wk "Signature help")
      "hg" '(lsp-ui-doc-glance :wk "Doc popup")

      ;; refactor
      "r"  '(nil :wk "Refactoring")
      "rr" '(lsp-rename :wk "Rename")
      "ro" '(lsp-organize-imports :wk "Organize imports")

      ;; actions
      "a"  '(nil :wk "Code actions")
      "aa" '(lsp-execute-code-action :wk "Code actions")
      "al" '(lsp-avy-lens :wk "Lens")
      "ah" '(lsp-document-highlight :wk "Highlight symbol")

      ;; peek
      "G"  '(nil :wk "Peek")
      "Gg" '(lsp-ui-peek-find-definitions :wk "Peek definitions")
      "Gr" '(lsp-ui-peek-find-references :wk "Peek references")
      "Gi" '(lsp-ui-peek-find-implementation :wk "Peek implementations")
      "Gs" '(lsp-ui-peek-find-workspace-symbol :wk "Peek workspace symbol")
      "GN" '(lsp-ui-peek-jump-backward :wk "Jump backward")
      "Gn" '(lsp-ui-peek-jump-forward :wk "Jump forward"))
    :custom
    (read-process-output-max (* 1024 1024) "Performace.")
    (lsp-auto-guess-root t "Detect project root.")
    (lsp-keep-workspace-alive nil "Auto-kill LSP server.")
    (lsp-diagnostic-package :flycheck)

    (lsp-pyls-configuration-sources ["flake8"])
    (lsp-pyls-plugins-autopep8-enabled nil)
    (lsp-pyls-plugins-pycodestyle-enabled nil)
    (lsp-pyls-plugins-pylint-enabled t)
    (lsp-pyls-plugins-yapf-enabled nil)

    :config
    (lsp-register-custom-settings
     '(("pyls.plugins.pyls_mypy.enabled" t t)
       ("pyls.plugins.pyls_mypy.live_mode" nil t)
       ("pyls.plugins.pyls_mypy.strict" t t))))
#+end_src

Nice UI

#+begin_src elisp
  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :commands lsp-ui-mode
    :general
    (:keymaps 'lsp-ui-peek-mode-map
              "h" 'lsp-ui-peek--select-prev-file
              "j" 'lsp-ui-peek--select-next
              "k" 'lsp-ui-peek--select-prev
              "l" 'lsp-ui-peek--select-next-file))
#+end_src

Company integration.

#+begin_src elisp
  (use-package company-lsp
    :commands company-lsp
    :custom
    (company-lsp-cache-candidates 'auto))
#+end_src

Ivy integration.

#+begin_src elisp
  (use-package lsp-ivy
    :after lsp-mode
    :commands lsp-ivy-workspace-symbol)
#+end_src

TODO: dap-mode
TODO: lsp-treemacs
** Programming Modes
*** Emacs Lisp
#+begin_src elisp
  (use-package elisp-mode
    :ensure nil
    :hook
    (emacs-lisp-mode . (lambda ()
                         (set (make-local-variable 'company-backends)
                              '((company-capf
                                 company-files
                                 company-yasnippet
                                 company-dabbrev-code)))
                         company-dabbrev-code
                         (company-mode t))))
#+end_src
*** C/C++
#+begin_src elisp
  (use-package cc-vars
    :ensure nil
    :defer t
    :custom
    (c-basic-offset 4 "Default indentation.")
    (c-default-style '((java-mode . "java")
                       (awk-mode . "awk")
                       (other . "k&r"))))
#+end_src
*** Nix
#+begin_src elisp
  (use-package nix-mode
    :mode ("\\.nix\\'" "\\.nix.in\\'")
    :custom
    (nix-indent-function 'smie-indent-line))


  (use-package nix-drv-mode
    :ensure nix-mode
    :mode "\\.drv\\'")


  (use-package nix-repl
    :ensure nix-mode
    :commands (nix-repl))


  (use-package nix-shell
    :ensure nix-mode
    :commands (nix-shell-unpack nix-shell-configure nix-shell-build))


  (use-package nix-format
    :ensure nix-mode
    :custom
    (nix-nixfmt-bin "nixpkgs-fmt" "Use nixpkgs-fmt instead of nixfmt-bin.")
    :commands (nix-format-buffer))
#+end_src
*** Python
#+begin_src elisp
  (use-package python
    :ensure nil
    :defer t
    :hook (python-mode . lsp-deferred))
#+end_src

Live coding in Python.

#+begin_src elisp
  (use-package live-py-mode)
#+end_src

Format buffer with =black=.

#+begin_src elisp
  (use-package python-black
    :hook (python-mode . python-black-on-save-mode))
#+end_src
*** Javascript
#+begin_src elisp
  (use-package js
    :ensure nil
    :defer t
    :custom
    (js-indent-level 2))
#+end_src
* The end…
Add standard module footer.

#+begin_src elisp
  (provide 'init)
  ;;; init.el ends here
#+end_src

Add on save hook to this file.

#+begin_src elisp :tangle no
  ;; Local Variables:
  ;; eval: (add-hook 'after-save-hook (lambda ()(org-babel-tangle)) nil t)
  ;; End:
#+end_src
